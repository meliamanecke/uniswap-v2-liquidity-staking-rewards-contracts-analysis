# Web3æ™ºèƒ½åˆçº¦å¼€å‘æŒ‡å—ï¼šæ·±å…¥è§£æ Uniswap V2 æµåŠ¨æ€§è´¨æŠ¼å¥–åŠ±æœºåˆ¶ | DeFiæŠ€æœ¯ç ”ç©¶

> ğŸ’¡ æœ¬æ–‡ç”±é¢†å…ˆçš„åŒºå—é“¾æŠ€æœ¯æœåŠ¡å•† [Crypto8848](https://crypto8848.com) æŠ€æœ¯å›¢é˜Ÿå‡ºå“ã€‚æˆ‘ä»¬ä¸“æ³¨äº DeFiã€DAppã€ç®—æ³• Token ç­‰ Web3 æ ¸å¿ƒæŠ€æœ¯å¼€å‘ï¼Œæä¾›å…¨æ–¹ä½çš„åŒºå—é“¾è§£å†³æ–¹æ¡ˆã€‚Telegramï¼š[@recoverybtc](https://t.me/recoverybtc)

## Crypto8848ï¼šæ‚¨çš„ä¸“ä¸š Web3 æŠ€æœ¯åˆä½œä¼™ä¼´

ä½œä¸º Web3 æ—¶ä»£çš„æŠ€æœ¯å…ˆé©±ï¼Œ[Crypto8848](https://crypto8848.com) å§‹ç»ˆèµ°åœ¨åŒºå—é“¾æŠ€æœ¯åˆ›æ–°çš„å‰æ²¿ï¼Œæˆ‘ä»¬çš„æ ¸å¿ƒä¼˜åŠ¿åŒ…æ‹¬ï¼š

### 1. å…¨é“¾ DeFi å¼€å‘æ–¹æ¡ˆ
- æ”¯æŒä»¥å¤ªåŠã€BSCã€Solana ç­‰ä¸»æµå…¬é“¾
- æ— ç¼é›†æˆ MetaMaskã€Trust Wallet ç­‰ä¸»æµ Web3 é’±åŒ…
- è®¡ç®—å±‚ä¸æ•°æ®å±‚åˆ†ç¦»çš„é«˜æ€§èƒ½æ¶æ„è®¾è®¡
- è‡ªä¸»ç ”å‘çš„é£æ§ç³»ç»Ÿï¼Œå…¨æ–¹ä½ä¿éšœèµ„é‡‘å®‰å…¨

### 2. åˆ›æ–°å‹ DApp ä¸ DeFi è§£å†³æ–¹æ¡ˆ
- ä¸º DeFi å’Œ DAO é¡¹ç›®æä¾›ç®—æ³•æ”¯æŒ
- é€šè¿‡æ™ºèƒ½ç®—æ³•å®ç°ä»£å¸ç»æµæ¨¡å‹
- è®¾è®¡å®Œå–„çš„å»ä¸­å¿ƒåŒ–æ²»ç†æœºåˆ¶
- æ„å»ºå¯æŒç»­å‘å±•çš„ DeFi ç”Ÿæ€ç³»ç»Ÿ

### 3. Web3 æ™ºèƒ½åˆçº¦å®šåˆ¶
- å…¨é“¾æ™ºèƒ½åˆçº¦å¼€å‘æœåŠ¡
- Web2 åˆ° Web3 çš„ä¸šåŠ¡å‡çº§æ–¹æ¡ˆ
- é«˜æ€§èƒ½åˆçº¦æ¶æ„è®¾è®¡
- æ™ºèƒ½åˆçº¦å®‰å…¨æ€§ä¼˜åŒ–

### 4. ç®—æ³• Token å®šåˆ¶å¼€å‘
- ç¨³å®šå¸ç®—æ³•è®¾è®¡ä¸å®ç°
- å¼¹æ€§ä¾›åº”ä»£å¸å¼€å‘
- æ™ºèƒ½å›è´­ä¸æµåŠ¨æ€§è°ƒèŠ‚
- åˆ›æ–°å‹ä»£å¸ç»æµæ¨¡å‹è®¾è®¡

> ğŸ“¢ åŒºå—é“¾æŠ€æœ¯å’¨è¯¢ä¸æ”¯æŒï¼š
> - å®˜ç½‘ï¼š[Crypto8848.com](https://crypto8848.com)
> - Telegramï¼š[@recoverybtc](https://t.me/recoverybtc)
> - ä¸šåŠ¡èŒƒå›´ï¼šDeFiåè®®å¼€å‘ã€DAppå®šåˆ¶å¼€å‘ã€æ™ºèƒ½åˆçº¦å¼€å‘ã€ç®—æ³•ç¨³å®šå¸å¼€å‘ç­‰
> - 24/7 ä¸“ä¸šæŠ€æœ¯æ”¯æŒï¼Œæ‰“é€ æ‚¨çš„ Web3 åˆ›æ–°é¡¹ç›®

## Uniswap V2 æµåŠ¨æ€§è´¨æŠ¼å¥–åŠ±ç³»ç»Ÿæ¦‚è¿°

Uniswap V2 çš„æµåŠ¨æ€§è´¨æŠ¼å¥–åŠ±ç³»ç»Ÿæ˜¯ä¸€ä¸ªåˆ›æ–°çš„ DeFi æœºåˆ¶ï¼Œæ—¨åœ¨é€šè¿‡ä»£å¸å¥–åŠ±æ¥æ¿€åŠ±ç”¨æˆ·ä¸ºäº¤æ˜“å¯¹æä¾›æµåŠ¨æ€§ã€‚è¯¥ç³»ç»ŸåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š

### 1. æµåŠ¨æ€§æŒ–çŸ¿æ ¸å¿ƒæœºåˆ¶
- ç”¨æˆ·è´¨æŠ¼ Uniswap V2 LP ä»£å¸è·å¾—å¥–åŠ±
- æ”¯æŒå¤šä¸ªäº¤æ˜“å¯¹åŒæ—¶è¿›è¡ŒæµåŠ¨æ€§æŒ–çŸ¿
- çµæ´»çš„å¥–åŠ±åˆ†é…å’Œæ—¶é—´æ§åˆ¶æœºåˆ¶

### 2. å·¥å‚åˆçº¦æ¨¡å¼
- ç»Ÿä¸€ç®¡ç†å¤šä¸ªè´¨æŠ¼æ± 
- æ ‡å‡†åŒ–çš„éƒ¨ç½²å’Œé…ç½®æµç¨‹
- å¯æ‰©å±•çš„å¥–åŠ±åˆ†å‘æœºåˆ¶

### 3. å®‰å…¨æ€§è®¾è®¡
- åŸºäº OpenZeppelin æ ‡å‡†å®ç°
- å¤šé‡å®‰å…¨æ£€æŸ¥æœºåˆ¶
- é˜²é‡å…¥å’ŒçŠ¶æ€ä¿æŠ¤è®¾è®¡

## StakingRewardsFactory åˆçº¦æŠ€æœ¯è§£æ

### 1. çŠ¶æ€å˜é‡
```solidity
// ä¸å¯å˜çŠ¶æ€å˜é‡
address public rewardsToken;        // å¥–åŠ±ä»£å¸åœ°å€
uint public stakingRewardsGenesis;  // è´¨æŠ¼å¥–åŠ±å¼€å§‹æ—¶é—´

// è´¨æŠ¼ä»£å¸æ•°ç»„
address[] public stakingTokens;     // æ‰€æœ‰å·²éƒ¨ç½²çš„è´¨æŠ¼ä»£å¸åœ°å€

// è´¨æŠ¼å¥–åŠ±ä¿¡æ¯ç»“æ„
struct StakingRewardsInfo {
    address stakingRewards;         // è´¨æŠ¼å¥–åŠ±åˆçº¦åœ°å€
    uint rewardAmount;              // å¥–åŠ±æ•°é‡
}

// è´¨æŠ¼å¥–åŠ±ä¿¡æ¯æ˜ å°„
mapping(address => StakingRewardsInfo) public stakingRewardsInfoByStakingToken;
```

### 2. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 2.1 æ„é€ å‡½æ•°
```solidity
constructor(
    address _rewardsToken,           // å¥–åŠ±ä»£å¸åœ°å€
    uint _stakingRewardsGenesis      // è´¨æŠ¼å¥–åŠ±å¼€å§‹æ—¶é—´
) Ownable() public {
    // ç¡®ä¿åˆ›ä¸–æ—¶é—´åœ¨å½“å‰æ—¶é—´ä¹‹å
    require(_stakingRewardsGenesis >= block.timestamp, 'StakingRewardsFactory::constructor: genesis too soon');

    rewardsToken = _rewardsToken;
    stakingRewardsGenesis = _stakingRewardsGenesis;
}
```

#### 2.2 è´¨æŠ¼æ± éƒ¨ç½²
```solidity
function deploy(address stakingToken, uint rewardAmount) public onlyOwner {
    // è·å–è´¨æŠ¼å¥–åŠ±ä¿¡æ¯
    StakingRewardsInfo storage info = stakingRewardsInfoByStakingToken[stakingToken];
    // ç¡®ä¿æœªé‡å¤éƒ¨ç½²
    require(info.stakingRewards == address(0), 'StakingRewardsFactory::deploy: already deployed');

    // éƒ¨ç½²æ–°çš„è´¨æŠ¼å¥–åŠ±åˆçº¦
    info.stakingRewards = address(new StakingRewards(
        address(this),    // å¥–åŠ±åˆ†å‘è€…
        rewardsToken,     // å¥–åŠ±ä»£å¸
        stakingToken      // è´¨æŠ¼ä»£å¸ï¼ˆLP tokenï¼‰
    ));
    info.rewardAmount = rewardAmount;
    stakingTokens.push(stakingToken);
}
```

#### 2.3 å¥–åŠ±åˆ†å‘æœºåˆ¶
```solidity
// æ‰¹é‡é€šçŸ¥å¥–åŠ±
function notifyRewardAmounts() public {
    require(stakingTokens.length > 0, 'StakingRewardsFactory::notifyRewardAmounts: called before any deploys');
    for (uint i = 0; i < stakingTokens.length; i++) {
        notifyRewardAmount(stakingTokens[i]);
    }
}

// å•æ± å¥–åŠ±é€šçŸ¥
function notifyRewardAmount(address stakingToken) public {
    require(block.timestamp >= stakingRewardsGenesis, 'StakingRewardsFactory::notifyRewardAmount: not ready');
    
    StakingRewardsInfo storage info = stakingRewardsInfoByStakingToken[stakingToken];
    require(info.stakingRewards != address(0), 'StakingRewardsFactory::notifyRewardAmount: not deployed');

    if (info.rewardAmount > 0) {
        uint rewardAmount = info.rewardAmount;
        info.rewardAmount = 0;

        require(
            IERC20(rewardsToken).transfer(info.stakingRewards, rewardAmount),
            'StakingRewardsFactory::notifyRewardAmount: transfer failed'
        );
        StakingRewards(info.stakingRewards).notifyRewardAmount(rewardAmount);
    }
}
```

### 3. å®‰å…¨æœºåˆ¶

#### 3.1 è®¿é—®æ§åˆ¶
- ä½¿ç”¨ OpenZeppelin çš„ `Ownable` åˆçº¦è¿›è¡Œæƒé™ç®¡ç†
- å…³é”®æ“ä½œï¼ˆå¦‚éƒ¨ç½²æ–°æ± ï¼‰é™åˆ¶åªèƒ½ç”±ç®¡ç†å‘˜æ‰§è¡Œ
- é˜²æ­¢æœªæˆæƒç”¨æˆ·æ“ä½œç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½

#### 3.2 çŠ¶æ€ä¿æŠ¤
- åˆ›ä¸–æ—¶é—´æ£€æŸ¥é˜²æ­¢è¿‡æ—©å¯åŠ¨
- é˜²æ­¢é‡å¤éƒ¨ç½²åŒä¸€äº¤æ˜“å¯¹çš„è´¨æŠ¼æ± 
- ç¡®ä¿åˆçº¦çŠ¶æ€çš„ä¸€è‡´æ€§å’Œå¯é¢„æµ‹æ€§

#### 3.3 èµ„é‡‘å®‰å…¨
- ä¸¥æ ¼çš„è½¬è´¦æ£€æŸ¥æœºåˆ¶
- åŸå­æ€§æ“ä½œä¿è¯çŠ¶æ€ä¸€è‡´
- æ¸…é›¶æœºåˆ¶é˜²æ­¢é‡å¤å‘æ”¾

## ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1. åˆçº¦å…³ç³»
```
StakingRewardsFactory
    â”œâ”€â”€ éƒ¨ç½²å’Œç®¡ç†å¤šä¸ª StakingRewards
    â””â”€â”€ æ§åˆ¶å¥–åŠ±åˆ†å‘æ—¶é—´å’Œæ•°é‡

StakingRewards
    â”œâ”€â”€ å¤„ç†ç”¨æˆ·è´¨æŠ¼/è§£è´¨æŠ¼
    â”œâ”€â”€ è®¡ç®—å’Œåˆ†å‘å¥–åŠ±
    â””â”€â”€ ç®¡ç†è´¨æŠ¼ä»£å¸ä½™é¢
```

### 2. æ•°æ®æµ
1. å·¥å‚åˆçº¦éƒ¨ç½²è´¨æŠ¼æ± 
2. ç”¨æˆ·æˆæƒå¹¶è´¨æŠ¼ LP ä»£å¸
3. å·¥å‚åˆçº¦åˆ†å‘å¥–åŠ±ä»£å¸
4. è´¨æŠ¼åˆçº¦è®¡ç®—å¹¶å‘æ”¾å¥–åŠ±

## æœ€ä½³å®è·µå»ºè®®

### 1. éƒ¨ç½²å‡†å¤‡
- ç¡®ä¿å¥–åŠ±ä»£å¸å·²ç»éƒ¨ç½²å¹¶æœ‰è¶³å¤Ÿä½™é¢
- ä»”ç»†è®¾ç½®åˆ›ä¸–æ—¶é—´ï¼Œç»™ç”¨æˆ·å……è¶³å‡†å¤‡æ—¶é—´
- åˆç†è§„åˆ’å„æ± å­çš„å¥–åŠ±åˆ†é…æ¯”ä¾‹

### 2. è¿è¥ç®¡ç†
- å®šæœŸç›‘æ§å„æ± å­çš„è´¨æŠ¼æƒ…å†µ
- åŠæ—¶è¡¥å……å¥–åŠ±ä»£å¸ä½™é¢
- æ³¨æ„ gas æˆæœ¬ä¼˜åŒ–ï¼Œç‰¹åˆ«æ˜¯æ‰¹é‡æ“ä½œ

### 3. é£é™©é˜²èŒƒ
- å®šæœŸå®¡è®¡åˆçº¦ä»£ç 
- ç›‘æ§å¼‚å¸¸äº¤æ˜“è¡Œä¸º
- å»ºç«‹åº”æ€¥å“åº”æœºåˆ¶

## å¼€å‘è€…æ³¨æ„äº‹é¡¹

1. **åˆçº¦éƒ¨ç½²**
   - ç¡®ä¿ä¾èµ–åˆçº¦ç‰ˆæœ¬æ­£ç¡®
   - éªŒè¯æ‰€æœ‰å‚æ•°çš„åˆæ³•æ€§
   - æµ‹è¯•ç½‘å……åˆ†æµ‹è¯•

2. **æ¥å£è°ƒç”¨**
   - æ­£ç¡®å¤„ç† approve æµç¨‹
   - æ³¨æ„å‡½æ•°è°ƒç”¨é¡ºåº
   - å¤„ç†æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸æƒ…å†µ

3. **å®‰å…¨å»ºè®®**
   - å®æ–½é€Ÿç‡é™åˆ¶
   - æ·»åŠ ç´§æ€¥æš‚åœæœºåˆ¶
   - åšå¥½å‚æ•°è¾¹ç•Œæ£€æŸ¥ 

## æ ¸å¿ƒåˆçº¦è¯¦ç»†åˆ†æ

### 1. StakingRewards.sol - è´¨æŠ¼å¥–åŠ±åˆçº¦

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒåˆçº¦ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·çš„è´¨æŠ¼ã€æç°å’Œå¥–åŠ±å‘æ”¾é€»è¾‘ã€‚

```solidity
// æŒ‡å®š Solidity ç¼–è¯‘å™¨ç‰ˆæœ¬
pragma solidity ^0.5.16;

// å¯¼å…¥ OpenZeppelin çš„æ•°å­¦åº“ï¼Œç”¨äºå®‰å…¨çš„æ•°å­¦è®¡ç®—
import "openzeppelin-solidity-2.3.0/contracts/math/Math.sol";
import "openzeppelin-solidity-2.3.0/contracts/math/SafeMath.sol";
// å¯¼å…¥ ERC20 ç›¸å…³æ¥å£å’Œå®‰å…¨åº“
import "openzeppelin-solidity-2.3.0/contracts/token/ERC20/ERC20Detailed.sol";
import "openzeppelin-solidity-2.3.0/contracts/token/ERC20/SafeERC20.sol";
// å¯¼å…¥é‡å…¥é”ï¼Œé˜²æ­¢é‡å…¥æ”»å‡»
import "openzeppelin-solidity-2.3.0/contracts/utils/ReentrancyGuard.sol";

// å¯¼å…¥è‡ªå®šä¹‰æ¥å£å’Œåˆçº¦
import "./interfaces/IStakingRewards.sol";
import "./RewardsDistributionRecipient.sol";

// åˆçº¦ç»§æ‰¿å…³ç³»å£°æ˜
contract StakingRewards is IStakingRewards, RewardsDistributionRecipient, ReentrancyGuard {
    // ä½¿ç”¨ SafeMath åº“é˜²æ­¢æ•°å€¼è®¡ç®—æº¢å‡º
    using SafeMath for uint256;
    using SafeERC20 for IERC20;

    /* ========== çŠ¶æ€å˜é‡ ========== */

    IERC20 public rewardsToken;          // å¥–åŠ±ä»£å¸åˆçº¦åœ°å€
    IERC20 public stakingToken;          // è´¨æŠ¼ä»£å¸åˆçº¦åœ°å€ï¼ˆLP tokenï¼‰
    uint256 public periodFinish = 0;     // å½“å‰å¥–åŠ±å‘¨æœŸç»“æŸæ—¶é—´
    uint256 public rewardRate = 0;       // æ¯ç§’å‘æ”¾çš„å¥–åŠ±æ•°é‡
    uint256 public rewardsDuration = 60 days;  // å¥–åŠ±æŒç»­æ—¶é—´ï¼ˆ60å¤©ï¼‰
    uint256 public lastUpdateTime;       // ä¸Šæ¬¡æ›´æ–°å¥–åŠ±çš„æ—¶é—´
    uint256 public rewardPerTokenStored; // æ¯ä¸ªä»£å¸ç´¯ç§¯çš„å¥–åŠ±æ•°é‡

    // ç”¨æˆ·ç›¸å…³çŠ¶æ€æ˜ å°„
    mapping(address => uint256) public userRewardPerTokenPaid;  // ç”¨æˆ·å·²é¢†å–çš„æ¯ä»£å¸å¥–åŠ±
    mapping(address => uint256) public rewards;                 // ç”¨æˆ·å¾…é¢†å–çš„å¥–åŠ±

    uint256 private _totalSupply;        // æ€»è´¨æŠ¼é‡
    mapping(address => uint256) private _balances;  // ç”¨æˆ·è´¨æŠ¼ä½™é¢

    /* ========== æ„é€ å‡½æ•° ========== */

    constructor(
        address _rewardsDistribution,  // å¥–åŠ±åˆ†å‘è€…åœ°å€
        address _rewardsToken,         // å¥–åŠ±ä»£å¸åœ°å€
        address _stakingToken          // è´¨æŠ¼ä»£å¸åœ°å€
    ) public {
        rewardsToken = IERC20(_rewardsToken);
        stakingToken = IERC20(_stakingToken);
        rewardsDistribution = _rewardsDistribution;
    }

    /* ========== è§†å›¾å‡½æ•° ========== */

    // è¿”å›æ€»è´¨æŠ¼é‡
    function totalSupply() external view returns (uint256) {
        return _totalSupply;
    }

    // è¿”å›æŒ‡å®šè´¦æˆ·çš„è´¨æŠ¼ä½™é¢
    function balanceOf(address account) external view returns (uint256) {
        return _balances[account];
    }

    // è®¡ç®—æœ€åä¸€æ¬¡å¯ä»¥è·å¾—å¥–åŠ±çš„æ—¶é—´
    function lastTimeRewardApplicable() public view returns (uint256) {
        return Math.min(block.timestamp, periodFinish);
    }

    // è®¡ç®—æ¯ä¸ªè´¨æŠ¼ä»£å¸å¯ä»¥è·å¾—çš„å¥–åŠ±æ•°é‡
    function rewardPerToken() public view returns (uint256) {
        if (_totalSupply == 0) {
            return rewardPerTokenStored;
        }
        return
            rewardPerTokenStored.add(
                lastTimeRewardApplicable()
                    .sub(lastUpdateTime)
                    .mul(rewardRate)
                    .mul(1e18)
                    .div(_totalSupply)
            );
    }

    // è®¡ç®—æŒ‡å®šè´¦æˆ·å·²ç»èµšå–ä½†æœªé¢†å–çš„å¥–åŠ±
    function earned(address account) public view returns (uint256) {
        return _balances[account]
            .mul(rewardPerToken().sub(userRewardPerTokenPaid[account]))
            .div(1e18)
            .add(rewards[account]);
    }

    // è¿”å›æ•´ä¸ªå¥–åŠ±æœŸé—´çš„æ€»å¥–åŠ±æ•°é‡
    function getRewardForDuration() external view returns (uint256) {
        return rewardRate.mul(rewardsDuration);
    }

    /* ========== å¯å˜çŠ¶æ€å‡½æ•° ========== */

    // ä½¿ç”¨ permit è¿›è¡Œè´¨æŠ¼ï¼ˆæ”¯æŒ gasless æˆæƒï¼‰
    function stakeWithPermit(
        uint256 amount,
        uint deadline,
        uint8 v,
        bytes32 r,
        bytes32 s
    ) external nonReentrant updateReward(msg.sender) {
        require(amount > 0, "Cannot stake 0");
        _totalSupply = _totalSupply.add(amount);
        _balances[msg.sender] = _balances[msg.sender].add(amount);

        // ä½¿ç”¨ permit è¿›è¡Œæˆæƒ
        IUniswapV2ERC20(address(stakingToken)).permit(
            msg.sender,
            address(this),
            amount,
            deadline,
            v,
            r,
            s
        );

        stakingToken.safeTransferFrom(msg.sender, address(this), amount);
        emit Staked(msg.sender, amount);
    }

    // æ ‡å‡†è´¨æŠ¼å‡½æ•°
    function stake(uint256 amount) external nonReentrant updateReward(msg.sender) {
        require(amount > 0, "Cannot stake 0");
        _totalSupply = _totalSupply.add(amount);
        _balances[msg.sender] = _balances[msg.sender].add(amount);
        stakingToken.safeTransferFrom(msg.sender, address(this), amount);
        emit Staked(msg.sender, amount);
    }

    // æå–è´¨æŠ¼ä»£å¸
    function withdraw(uint256 amount) public nonReentrant updateReward(msg.sender) {
        require(amount > 0, "Cannot withdraw 0");
        _totalSupply = _totalSupply.sub(amount);
        _balances[msg.sender] = _balances[msg.sender].sub(amount);
        stakingToken.safeTransfer(msg.sender, amount);
        emit Withdrawn(msg.sender, amount);
    }

    // é¢†å–å¥–åŠ±
    function getReward() public nonReentrant updateReward(msg.sender) {
        uint256 reward = rewards[msg.sender];
        if (reward > 0) {
            rewards[msg.sender] = 0;
            rewardsToken.safeTransfer(msg.sender, reward);
            emit RewardPaid(msg.sender, reward);
        }
    }

    // é€€å‡ºï¼šæå–å…¨éƒ¨è´¨æŠ¼å¹¶é¢†å–å¥–åŠ±
    function exit() external {
        withdraw(_balances[msg.sender]);
        getReward();
    }

    /* ========== å—é™å‡½æ•° ========== */

    // é€šçŸ¥æ–°çš„å¥–åŠ±é‡‘é¢ï¼ˆåªèƒ½ç”±å¥–åŠ±åˆ†å‘è€…è°ƒç”¨ï¼‰
    function notifyRewardAmount(uint256 reward) 
        external 
        onlyRewardsDistribution 
        updateReward(address(0)) 
    {
        // å¦‚æœå½“å‰å‘¨æœŸå·²ç»“æŸï¼Œç›´æ¥è®¾ç½®æ–°çš„å¥–åŠ±ç‡
        if (block.timestamp >= periodFinish) {
            rewardRate = reward.div(rewardsDuration);
        } else {
            // å¦‚æœå½“å‰å‘¨æœŸæœªç»“æŸï¼Œéœ€è¦è€ƒè™‘å‰©ä½™çš„å¥–åŠ±
            uint256 remaining = periodFinish.sub(block.timestamp);
            uint256 leftover = remaining.mul(rewardRate);
            rewardRate = reward.add(leftover).div(rewardsDuration);
        }

        // ç¡®ä¿å¥–åŠ±ç‡ä¸ä¼šå¯¼è‡´åˆçº¦ä½™é¢ä¸è¶³
        uint balance = rewardsToken.balanceOf(address(this));
        require(rewardRate <= balance.div(rewardsDuration), "Provided reward too high");

        lastUpdateTime = block.timestamp;
        periodFinish = block.timestamp.add(rewardsDuration);
        emit RewardAdded(reward);
    }

    /* ========== ä¿®æ”¹å™¨ ========== */

    // æ›´æ–°å¥–åŠ±çš„ä¿®æ”¹å™¨
    modifier updateReward(address account) {
        rewardPerTokenStored = rewardPerToken();
        lastUpdateTime = lastTimeRewardApplicable();
        if (account != address(0)) {
            rewards[account] = earned(account);
            userRewardPerTokenPaid[account] = rewardPerTokenStored;
        }
        _;
    }

    /* ========== äº‹ä»¶ ========== */

    event RewardAdded(uint256 reward);           // æ·»åŠ æ–°çš„å¥–åŠ±
    event Staked(address indexed user, uint256 amount);     // è´¨æŠ¼äº‹ä»¶
    event Withdrawn(address indexed user, uint256 amount);  // æç°äº‹ä»¶
    event RewardPaid(address indexed user, uint256 reward); // é¢†å–å¥–åŠ±äº‹ä»¶
}

// Uniswap V2 ERC20 æ¥å£ï¼Œç”¨äº permit åŠŸèƒ½
interface IUniswapV2ERC20 {
    function permit(
        address owner,
        address spender,
        uint value,
        uint deadline,
        uint8 v,
        bytes32 r,
        bytes32 s
    ) external;
}
```

### 2. RewardsDistributionRecipient.sol - å¥–åŠ±åˆ†å‘æ¥æ”¶è€…åˆçº¦

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æŠ½è±¡åˆçº¦ï¼Œç”¨äºæ§åˆ¶å¥–åŠ±åˆ†å‘æƒé™ã€‚

```solidity
// æŒ‡å®š Solidity ç¼–è¯‘å™¨ç‰ˆæœ¬
pragma solidity ^0.5.16;

// æŠ½è±¡åˆçº¦ï¼šå®šä¹‰å¥–åŠ±åˆ†å‘çš„åŸºæœ¬ç»“æ„
abstract contract RewardsDistributionRecipient {
    // å¥–åŠ±åˆ†å‘è€…åœ°å€
    address public rewardsDistribution;

    // é™åˆ¶åªæœ‰å¥–åŠ±åˆ†å‘è€…å¯ä»¥è°ƒç”¨çš„ä¿®æ”¹å™¨
    modifier onlyRewardsDistribution() {
        require(msg.sender == rewardsDistribution, "Caller is not RewardsDistribution contract");
        _;
    }
}
```

### 3. IStakingRewards.sol - è´¨æŠ¼å¥–åŠ±æ¥å£

è¿™æ˜¯è´¨æŠ¼å¥–åŠ±åˆçº¦çš„æ¥å£å®šä¹‰ã€‚

```solidity
// æŒ‡å®š Solidity ç¼–è¯‘å™¨ç‰ˆæœ¬
pragma solidity ^0.5.16;

// å®šä¹‰è´¨æŠ¼å¥–åŠ±åˆçº¦çš„æ ‡å‡†æ¥å£
interface IStakingRewards {
    // æŸ¥è¯¢å‡½æ•°
    function lastTimeRewardApplicable() external view returns (uint256);
    function rewardPerToken() external view returns (uint256);
    function earned(address account) external view returns (uint256);
    function getRewardForDuration() external view returns (uint256);
    function totalSupply() external view returns (uint256);
    function balanceOf(address account) external view returns (uint256);

    // çŠ¶æ€ä¿®æ”¹å‡½æ•°
    function stake(uint256 amount) external;
    function withdraw(uint256 amount) external;
    function getReward() external;
    function exit() external;
}
```

## åˆçº¦äº¤äº’æµç¨‹

1. **åˆå§‹åŒ–æµç¨‹**
   ```mermaid
   sequenceDiagram
       participant Owner
       participant Factory
       participant StakingRewards
       participant User

       Owner->>Factory: éƒ¨ç½²å·¥å‚åˆçº¦
       Owner->>Factory: è®¾ç½®å¥–åŠ±ä»£å¸å’Œå¼€å§‹æ—¶é—´
       Owner->>Factory: éƒ¨ç½²è´¨æŠ¼æ± (deploy)
       Factory->>StakingRewards: åˆ›å»ºæ–°çš„è´¨æŠ¼å¥–åŠ±åˆçº¦
       Factory->>StakingRewards: è®¾ç½®åˆå§‹å‚æ•°
   ```

2. **è´¨æŠ¼æµç¨‹**
   ```mermaid
   sequenceDiagram
       participant User
       participant StakingRewards
       participant LP Token

       User->>LP Token: approve(è´¨æŠ¼åˆçº¦åœ°å€)
       User->>StakingRewards: stake(æ•°é‡)
       StakingRewards->>LP Token: transferFrom(ç”¨æˆ·åœ°å€, åˆçº¦åœ°å€, æ•°é‡)
       StakingRewards->>StakingRewards: æ›´æ–°ç”¨æˆ·ä½™é¢å’Œæ€»ä¾›åº”é‡
   ```

3. **å¥–åŠ±å‘æ”¾æµç¨‹**
   ```mermaid
   sequenceDiagram
       participant Factory
       participant StakingRewards
       participant Reward Token

       Factory->>StakingRewards: notifyRewardAmount(æ•°é‡)
       StakingRewards->>StakingRewards: è®¡ç®—æ–°çš„å¥–åŠ±ç‡
       StakingRewards->>StakingRewards: æ›´æ–°å¥–åŠ±æœŸé—´
   ```

## æŠ€æœ¯è¦ç‚¹è§£æ

### 1. å¥–åŠ±è®¡ç®—æœºåˆ¶

å¥–åŠ±è®¡ç®—é‡‡ç”¨ç´¯ç§¯æœºåˆ¶ï¼Œä¸»è¦é€šè¿‡ä»¥ä¸‹å…¬å¼ï¼š

\[
earned = userBalance * (rewardPerToken - userRewardPerTokenPaid) + rewards
\]

å…¶ä¸­ï¼š
- `rewardPerToken` æ˜¯æ¯ä¸ªè´¨æŠ¼ä»£å¸ç´¯ç§¯çš„å¥–åŠ±æ•°é‡
- `userRewardPerTokenPaid` æ˜¯ç”¨æˆ·ä¸Šæ¬¡é¢†å–æ—¶çš„ç´¯ç§¯å€¼
- `rewards` æ˜¯ç”¨æˆ·å¾…é¢†å–çš„å¥–åŠ±

### 2. å®‰å…¨æœºåˆ¶

1. **é‡å…¥æ”»å‡»é˜²æŠ¤**
   - ä½¿ç”¨ OpenZeppelin çš„ `ReentrancyGuard`
   - æ‰€æœ‰å¤–éƒ¨è°ƒç”¨å‰æ›´æ–°çŠ¶æ€
   - ä½¿ç”¨ `safeTransfer` å’Œ `safeTransferFrom`

2. **æ•°å€¼å®‰å…¨**
   - ä½¿ç”¨ SafeMath åº“é˜²æ­¢æº¢å‡º
   - å¥–åŠ±ç‡ä¸Šé™æ£€æŸ¥
   - é›¶å€¼æ£€æŸ¥

3. **æƒé™æ§åˆ¶**
   - å·¥å‚åˆçº¦æ§åˆ¶éƒ¨ç½²
   - å¥–åŠ±åˆ†å‘æƒé™é™åˆ¶
   - çŠ¶æ€æ›´æ–°ä¿æŠ¤

### 3. Gas ä¼˜åŒ–

1. **å­˜å‚¨ä¼˜åŒ–**
   - ä½¿ç”¨ `uint256` ç±»å‹ä¼˜åŒ–å­˜å‚¨
   - åˆç†ä½¿ç”¨ `view` å‡½æ•°
   - çŠ¶æ€å˜é‡æ‰“åŒ…

2. **è®¡ç®—ä¼˜åŒ–**
   - æ‰¹é‡æ›´æ–°æœºåˆ¶
   - ä½¿ç”¨ä¿®æ”¹å™¨åˆå¹¶é‡å¤ä»£ç 
   - é¿å…é‡å¤è®¡ç®—

## æœ€ä½³å®è·µå»ºè®®

### 1. éƒ¨ç½²æµç¨‹

```solidity
// 1. éƒ¨ç½²å·¥å‚åˆçº¦
const factory = await StakingRewardsFactory.deploy(
    rewardsToken.address,
    stakingRewardsGenesis
);

// 2. ä¸ºæ¯ä¸ª LP ä»£å¸éƒ¨ç½²è´¨æŠ¼æ± 
await factory.deploy(lpToken.address, rewardAmount);

// 3. è½¬å…¥å¥–åŠ±ä»£å¸
await rewardsToken.transfer(factory.address, totalRewards);

// 4. å¯åŠ¨å¥–åŠ±
await factory.notifyRewardAmounts();
```

### 2. ç”¨æˆ·äº¤äº’å»ºè®®

```solidity
// 1. æˆæƒè´¨æŠ¼
await lpToken.approve(stakingRewards.address, amount);

// 2. è´¨æŠ¼ä»£å¸
await stakingRewards.stake(amount);

// 3. å®šæœŸæŸ¥çœ‹å¥–åŠ±
const earned = await stakingRewards.earned(userAddress);

// 4. é¢†å–å¥–åŠ±
await stakingRewards.getReward();

// 5. é€€å‡ºè´¨æŠ¼
await stakingRewards.exit();
```

### 3. è¿è¥ç®¡ç†å»ºè®®

1. **ç›‘æ§æŒ‡æ ‡**
   - æ€»è´¨æŠ¼é‡å˜åŒ–
   - å¥–åŠ±åˆ†å‘æƒ…å†µ
   - ç”¨æˆ·å‚ä¸åº¦

2. **é£é™©æ§åˆ¶**
   - å®šæœŸå®¡è®¡åˆçº¦
   - ç›‘æ§å¼‚å¸¸äº¤æ˜“
   - è®¾ç½®é¢„è­¦æœºåˆ¶

3. **ä¼˜åŒ–å»ºè®®**
   - æ ¹æ®å¸‚åœºè°ƒæ•´å¥–åŠ±ç‡
   - ä¼˜åŒ–å¥–åŠ±å‘¨æœŸ
   - å¹³è¡¡èµ„é‡‘æ•ˆç‡

## å¼€å‘è€…å·¥å…·

### 1. åˆçº¦äº¤äº’è„šæœ¬

```javascript
// éƒ¨ç½²è„šæœ¬
async function deployStakingRewards(
    rewardsToken,
    stakingToken,
    rewardAmount,
    duration
) {
    // éƒ¨ç½²å·¥å‚åˆçº¦
    const factory = await StakingRewardsFactory.deploy(
        rewardsToken,
        Math.floor(Date.now() / 1000) + 3600 // 1å°æ—¶åå¼€å§‹
    );

    // éƒ¨ç½²è´¨æŠ¼æ± 
    await factory.deploy(stakingToken, rewardAmount);

    return factory;
}

// ç›‘æ§è„šæœ¬
async function monitorStakingPool(stakingRewards) {
    const totalSupply = await stakingRewards.totalSupply();
    const rewardRate = await stakingRewards.rewardRate();
    const periodFinish = await stakingRewards.periodFinish();

    console.log(`
        Total Staked: ${totalSupply}
        Reward Rate: ${rewardRate}/sec
        Period Finish: ${new Date(periodFinish * 1000)}
    `);
}
```

### 2. æµ‹è¯•ç”¨ä¾‹

```javascript
describe("StakingRewards", function() {
    it("should stake tokens correctly", async function() {
        // å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
        const [owner, user] = await ethers.getSigners();
        const stakingRewards = await deployStakingRewards();
        
        // æ‰§è¡Œè´¨æŠ¼
        await lpToken.connect(user).approve(stakingRewards.address, amount);
        await stakingRewards.connect(user).stake(amount);
        
        // éªŒè¯ç»“æœ
        expect(await stakingRewards.balanceOf(user.address)).to.equal(amount);
    });

    it("should calculate rewards correctly", async function() {
        // ... å¥–åŠ±è®¡ç®—æµ‹è¯•
    });

    it("should handle emergency situations", async function() {
        // ... ç´§æ€¥æƒ…å†µå¤„ç†æµ‹è¯•
    });
});
```

## æ€»ç»“

Uniswap V2 çš„æµåŠ¨æ€§è´¨æŠ¼å¥–åŠ±ç³»ç»Ÿæ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯çš„ DeFi åŸºç¡€è®¾æ–½ï¼Œå®ƒé€šè¿‡ä»¥ä¸‹ç‰¹ç‚¹ä¿è¯äº†ç³»ç»Ÿçš„å¯é æ€§å’Œæ•ˆç‡ï¼š

1. **æ¨¡å—åŒ–è®¾è®¡**
   - å·¥å‚åˆçº¦è´Ÿè´£éƒ¨ç½²å’Œç®¡ç†
   - è´¨æŠ¼åˆçº¦å¤„ç†æ ¸å¿ƒé€»è¾‘
   - æ¥å£å®šä¹‰ç¡®ä¿æ ‡å‡†åŒ–

2. **å®‰å…¨æ€§è€ƒè™‘**
   - å¤šé‡å®‰å…¨æ£€æŸ¥
   - å®Œå–„çš„æƒé™æ§åˆ¶
   - é˜²é‡å…¥ä¿æŠ¤

3. **çµæ´»æ€§**
   - å¯é…ç½®çš„å¥–åŠ±å‚æ•°
   - æ”¯æŒå¤šç§è´¨æŠ¼æ± 
   - å¯æ‰©å±•çš„æ¶æ„

4. **æ•ˆç‡ä¼˜åŒ–**
   - Gas ä¼˜åŒ–è®¾è®¡
   - æ‰¹é‡æ“ä½œæ”¯æŒ
   - çŠ¶æ€æ›´æ–°ä¼˜åŒ–

è¿™ä¸ªç³»ç»Ÿä¸º DeFi é¡¹ç›®æä¾›äº†ä¸€ä¸ªå¯é çš„æµåŠ¨æ€§æ¿€åŠ±æ–¹æ¡ˆï¼Œå¯ä»¥ä½œä¸ºå…¶ä»–é¡¹ç›®çš„å‚è€ƒå®ç°ã€‚ 
